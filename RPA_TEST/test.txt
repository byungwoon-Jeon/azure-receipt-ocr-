# --- 기존 INSERT 요약(sql) 자리에 교체 ---
merge_summ_sql = text("""
MERGE INTO MISADM.RPA_CCR_LINE_SUMM AS T
USING (
    SELECT
        :FIID           AS FIID,
        :GUBUN          AS GUBUN,
        :LINE_INDEX     AS LINE_INDEX,
        :RECEIPT_INDEX  AS RECEIPT_INDEX,
        :COMMON_YN      AS COMMON_YN,
        :ATTACH_FILE    AS ATTACH_FILE,
        :COUNTRY        AS COUNTRY,
        :RECEIPT_TYPE   AS RECEIPT_TYPE,
        :MERCHANT_NAME  AS MERCHANT_NAME,
        :MERCHANT_PHONE_NO AS MERCHANT_PHONE_NO,
        :DELIVERY_ADDR  AS DELIVERY_ADDR,
        :TRANSACTION_DATE AS TRANSACTION_DATE,
        :TRANSACTION_TIME AS TRANSACTION_TIME,
        :TOTAL_AMOUNT   AS TOTAL_AMOUNT,
        :SUMTOTAL_AMOUNT AS SUMTOTAL_AMOUNT,
        :TAX_AMOUNT     AS TAX_AMOUNT,
        :BIZ_NO         AS BIZ_NO,
        :APPROVAL_NO    AS APPROVAL_NO,
        :RESULT_CODE    AS RESULT_CODE,
        :RESULT_MESSAGE AS RESULT_MESSAGE,
        :CREATE_DATE    AS CREATE_DATE
    FROM DUMMY
) AS S
ON (
    T.FIID = S.FIID
    AND T.LINE_INDEX = S.LINE_INDEX
    AND T.RECEIPT_INDEX = S.RECEIPT_INDEX
    AND T.COMMON_YN = S.COMMON_YN
)
WHEN MATCHED THEN
    UPDATE SET
        T.GUBUN = S.GUBUN,
        T.ATTACH_FILE = S.ATTACH_FILE,
        T.COUNTRY = S.COUNTRY,
        T.RECEIPT_TYPE = S.RECEIPT_TYPE,
        T.MERCHANT_NAME = S.MERCHANT_NAME,
        T.MERCHANT_PHONE_NO = S.MERCHANT_PHONE_NO,
        T.DELIVERY_ADDR = S.DELIVERY_ADDR,
        T.TRANSACTION_DATE = S.TRANSACTION_DATE,
        T.TRANSACTION_TIME = S.TRANSACTION_TIME,
        T.TOTAL_AMOUNT = S.TOTAL_AMOUNT,
        T.SUMTOTAL_AMOUNT = S.SUMTOTAL_AMOUNT,
        T.TAX_AMOUNT = S.TAX_AMOUNT,
        T.BIZ_NO = S.BIZ_NO,
        T.APPROVAL_NO = S.APPROVAL_NO,
        T.RESULT_CODE = S.RESULT_CODE,
        T.RESULT_MESSAGE = S.RESULT_MESSAGE,
        T.UPDATE_DATE = CURRENT_TIMESTAMP
WHEN NOT MATCHED THEN
    INSERT (
        FIID, GUBUN, LINE_INDEX, RECEIPT_INDEX, COMMON_YN, ATTACH_FILE,
        COUNTRY, RECEIPT_TYPE, MERCHANT_NAME, MERCHANT_PHONE_NO,
        DELIVERY_ADDR, TRANSACTION_DATE, TRANSACTION_TIME,
        TOTAL_AMOUNT, SUMTOTAL_AMOUNT, TAX_AMOUNT, BIZ_NO, APPROVAL_NO,
        RESULT_CODE, RESULT_MESSAGE, CREATE_DATE, UPDATE_DATE
    )
    VALUES (
        S.FIID, S.GUBUN, S.LINE_INDEX, S.RECEIPT_INDEX, S.COMMON_YN, S.ATTACH_FILE,
        S.COUNTRY, S.RECEIPT_TYPE, S.MERCHANT_NAME, S.MERCHANT_PHONE_NO,
        S.DELIVERY_ADDR, S.TRANSACTION_DATE, S.TRANSACTION_TIME,
        S.TOTAL_AMOUNT, S.SUMTOTAL_AMOUNT, S.TAX_AMOUNT, S.BIZ_NO, S.APPROVAL_NO,
        S.RESULT_CODE, S.RESULT_MESSAGE, S.CREATE_DATE, CURRENT_TIMESTAMP
    )
""")

# 실행
conn.execute(merge_summ_sql, summary)


# --- 기존 INSERT 아이템(sql) 루프 자리에 교체 ---
merge_item_sql = text("""
MERGE INTO MISADM.RPA_CCR_LINE_ITEMS AS T
USING (
    SELECT
        :FIID          AS FIID,
        :LINE_INDEX    AS LINE_INDEX,
        :RECEIPT_INDEX AS RECEIPT_INDEX,
        :ITEM_INDEX    AS ITEM_INDEX,
        :ITEM_NAME     AS ITEM_NAME,
        :ITEM_QTY      AS ITEM_QTY,
        :ITEM_UNIT_PRICE AS ITEM_UNIT_PRICE,
        :ITEM_TOTAL_PRICE AS ITEM_TOTAL_PRICE,
        :CONTENTS      AS CONTENTS,
        :COMMON_YN     AS COMMON_YN,
        :CREATE_DATE   AS CREATE_DATE
    FROM DUMMY
) AS S
ON (
    T.FIID = S.FIID
    AND T.LINE_INDEX = S.LINE_INDEX
    AND T.RECEIPT_INDEX = S.RECEIPT_INDEX
    AND T.ITEM_INDEX = S.ITEM_INDEX
    AND T.COMMON_YN = S.COMMON_YN
)
WHEN MATCHED THEN
    UPDATE SET
        T.ITEM_NAME = S.ITEM_NAME,
        T.ITEM_QTY = S.ITEM_QTY,
        T.ITEM_UNIT_PRICE = S.ITEM_UNIT_PRICE,
        T.ITEM_TOTAL_PRICE = S.ITEM_TOTAL_PRICE,
        T.CONTENTS = S.CONTENTS,
        T.UPDATE_DATE = CURRENT_TIMESTAMP
WHEN NOT MATCHED THEN
    INSERT (
        FIID, LINE_INDEX, RECEIPT_INDEX, ITEM_INDEX,
        ITEM_NAME, ITEM_QTY, ITEM_UNIT_PRICE, ITEM_TOTAL_PRICE,
        CONTENTS, COMMON_YN, CREATE_DATE, UPDATE_DATE
    )
    VALUES (
        S.FIID, S.LINE_INDEX, S.RECEIPT_INDEX, S.ITEM_INDEX,
        S.ITEM_NAME, S.ITEM_QTY, S.ITEM_UNIT_PRICE, S.ITEM_TOTAL_PRICE,
        S.CONTENTS, S.COMMON_YN, S.CREATE_DATE, CURRENT_TIMESTAMP
    )
""")

for item in items:
    conn.execute(merge_item_sql, item)

conn.commit()


SELECT COUNT(*) AS CNT
FROM LDCOM_CARDFILE_LOG
WHERE RESULT_CODE = '200'
  AND (CONTENT IS NULL OR CONTENT = '')
  AND UPDATE_DATE = '2025-09-30';
