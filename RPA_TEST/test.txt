import os
import logging
from PIL import Image

logger = logging.getLogger("PREPROCESS")

def convert_to_png(input_path: str, output_dir: str, fiid: str) -> str:
    """
    입력 파일을 PNG로 변환하고, 파일명 끝에 FIID를 붙여서 저장한다.
    
    Args:
        input_path (str): 변환할 원본 파일 경로
        output_dir (str): 변환된 파일을 저장할 디렉토리
        fiid (str): 파일명 끝에 붙일 식별자
    
    Returns:
        str: 변환된 PNG 파일 경로
    """
    try:
        if not os.path.exists(input_path):
            raise FileNotFoundError(f"Input file not found: {input_path}")
        if not os.path.isdir(output_dir):
            os.makedirs(output_dir, exist_ok=True)

        basename = os.path.basename(input_path)
        filename, _ = os.path.splitext(basename)

        # FIID 붙이기
        output_filename = f"{filename}_{fiid}.png"
        output_path = os.path.join(output_dir, output_filename)

        with Image.open(input_path) as img:
            img.convert("RGB").save(output_path, "PNG")

        logger.info(f"Converted {input_path} -> {output_path}")
        return output_path

    except Exception as e:
        logger.error(f"convert_to_png failed for {input_path}: {e}", exc_info=True)
        raise