idp_items = ret_json["idp_items"]

fail_lines = []
total_count = len(idp_items)
fail_count = 0

for idp_item in idp_items:
    if not idp_item["has_error"]:
        continue

    fail_count += 1

    padded_values = []

    padded_values.append(pad_string(idp_item["FIID"], column_width["EM_FIID"] - 4))
    padded_values.append(pad_string(idp_item["LINE_INDEX"], column_width["LINE_INDEX"] - 4))
    padded_values.append(pad_string(idp_item["RECEIPT_INDEX"], column_width["EM_RECEIPT_INDEX"] - 4))

    padded_has_error = pad_string("비정상", column_widths["수행결과"] - 4)
    padded_values.append(f"[[{padded_has_error}]]")

    error_message = idp_item["error_message"] or "N/A"
    padded_error_message = pad_string(error_message, column_widths["오류메시지"] - 4)
    padded_values.append(padded_error_message)

    fail_lines.append(" ".join(padded_values))

# ── 결과 메시지 구성
if fail_lines:
    summary_line = f"TOTAL: {total_count} | FAIL: {fail_count}"
    final_message = "\n".join(fail_lines + ["-" * 40, summary_line])
else:
    final_message = None  # 또는 "ALL_OK"