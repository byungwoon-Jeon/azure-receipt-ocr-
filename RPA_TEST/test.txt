# 상단 import (없으면 추가)
import io
import zipfile
from PIL import Image

# ...중략...

elif ext in [".docx", ".pptx", ".xlsx"]:
    media_path = {
        ".docx": "word/media/",
        ".pptx": "ppt/media/",
        ".xlsx": "xl/media/"
    }[ext]

    with zipfile.ZipFile(file_path, 'r') as zf:
        entries = sorted(
            [f for f in zf.namelist()
             if f.lower().startswith(media_path)
             and f.lower().endswith((".png", ".jpg", ".jpeg"))]
        )
        for name in entries:
            try:
                # ❗파일 핸들 대신 바이트로 읽어서 메모리로 고정
                data = zf.read(name)
                img = Image.open(io.BytesIO(data))
                # ❗지연로딩 방지: 지금 메모리로 완전히 디코딩
                img.load()          # 또는 img = img.copy()
                if img.mode != "RGB":
                    img = img.convert("RGB")
                # (원하면 dpi 힌트도 부여)
                # img.info["dpi"] = (200, 200)
                images.append(img)
            except Exception as e:
                logger.warning(f"[WARN] 이미지 추출 실패: {name} - {e}")
                continue